# This Python file uses the following encoding: utf-8
import sys
import csv
import datetime
from pymongo import MongoClient
from collections import Counter, defaultdict
import datetime


sys.stdout = sys.stderr

main_db_host = 'srv-5.yottos.com:27018,srv-5.yottos.com:27019,srv-5.yottos.com:27020'
conn = MongoClient(host=main_db_host)
db = conn.getmyad_db

date = datetime.datetime.now()
dateS = datetime.datetime(date.year, date.month, date.day -1, 0, 0)
dateE = datetime.datetime(date.year, date.month, date.day, 0, 0)
stats = defaultdict(int)
pipeline = [
            {'$match':
                {
                    'date': {'$gte': dateS, '$lte': dateE}
                }
            },
            {'$group':
                {
                    '_id': {
                        'adv': '$adv'
                    },
                    'impressions_block': {'$sum': '$impressions_block'}
                }
            }
        ]
cursor = db.stats.daily.adv.aggregate(pipeline=pipeline, useCursor=True)
for item in cursor:
    stats[item['_id']['adv']] = item['impressions_block']

inf = {}
for block in db.informer.find({}, {'guid': 1, 'user': 1, 'domain': 1, 'title': 1}):
    inf[block['guid']] = block


blocks = [
    ('2', '01412e28-28f1-11e7-98b7-002590d97638'),
    ('3', '01f23ad6-b97b-11e7-819a-002590d97638'),
    ('2', '03da43fe-0cef-11e7-97e4-00e081bad46a'),
    ('1', '0478c234-002a-11e8-ae4f-002590d97638'),
    ('43', '04ffc86c-d84e-11e4-b61e-002590d8e030'),
    ('1', '05747d1a-c04c-11e5-b33e-002590d8e030'),
    ('47471', '057b65dc-4a2f-11e5-ac7b-002590d8e030'),
    ('12', '065dbd12-824a-11e5-9ca4-002590d8e030'),
    ('1', '068c37a2-54cf-11e6-8076-002590d97638'),
    ('32', '08a823a6-47ed-11e5-9726-002590d8e030'),
    ('1', '0931a878-dc07-11e7-8335-002590d97638'),
    ('9', '0addb46e-196e-11e4-a68f-002590d75952'),
    ('1', '0d0ad374-1b65-11e7-8c29-002590d97638'),
    ('1', '0fd20e52-b4b7-11e1-9054-00163e0300c1'),
    ('1', '107c591e-8208-11e3-b763-002590d75952'),
    ('2', '12ba3776-02ad-11e8-ae50-002590d97638'),
    ('2', '12c74016-1464-11e7-9e8d-002590d97638'),
    ('9', '1528f350-b582-11e5-949d-002590d590d0'),
    ('7', '162b4134-7a64-11e6-bc08-002590d97638'),
    ('1', '1747b884-2bff-11e7-aa77-002590d97638'),
    ('1', '18ce799e-a817-11e5-abbd-00e081bad46a'),
    ('8', '1917b6ec-16e9-11e4-bc12-002590d75952'),
    ('3', '1ad41f28-0035-11e8-ae4f-002590d97638'),
    ('193', '1bcceac2-8148-11e5-b149-002590d97638'),
    ('1', '1d641b6a-ff79-11e7-ae4e-002590d97638'),
    ('4', '1fa2f514-186a-11e7-8c29-002590d97638'),
    ('1', '1fbb809a-1bd7-11e3-8d57-00e081bad801'),
    ('33', '2051a69e-8bfc-11e7-b157-002590d97638'),
    ('12', '209eb962-b0cc-11e7-9422-002590d75952'),
    ('2', '21c1ce36-cfca-11e5-a0e8-002590d97638'),
    ('7', '2780573e-089a-11e7-80f0-002590d97638'),
    ('49', '28b61d4c-514d-11e5-a105-002590d97638'),
    ('3', '2ab2bb5c-6643-11e7-aba2-002590d97638'),
    ('1739', '2d8efa2a-f6ad-11e7-b62e-002590d75952'),
    ('1583', '2f76aaec-9901-11e5-ad65-002590d97638'),
    ('1', '2fa8ba08-5e74-11e6-9838-00e081bad46a'),
    ('1', '32b6b67e-cb6e-11e7-a6df-002590d97638'),
    ('4', '32fca780-2a4a-11e7-98b7-002590d97638'),
    ('1', '3311205a-2bff-11e7-a488-002590d97638'),
    ('12', '357a7174-896c-11e6-a76d-002590d97638'),
    ('1', '35b9a176-3f86-11e6-9829-002590d97638'),
    ('1', '3759ba82-0b10-11e3-a23f-00e081bad46b'),
    ('1', '377bfa34-e77c-11e5-a662-002590d8e030'),
    ('3', '38790d38-6bb4-11e7-941b-002590d97638'),
    ('1', '3b86d07a-e072-11e4-96fe-002590d75952'),
    ('7', '3cda8eb4-1958-4557-8f55-e28f1814d8a4'),
    ('10', '3d0064ec-7f19-11e6-95b9-002590d97638'),
    ('2', '3e612940-ad58-11e5-be5a-002590d97638'),
    ('5', '3ee42f50-47ed-11e5-8e10-002590d8e030'),
    ('21', '42deb032-4566-11e5-a9a8-002590d97638'),
    ('48', '435e5354-f42a-11e6-a52d-002590d97638'),
    ('1', '464f1592-6f52-11e6-8acb-002590d97638'),
    ('2', '47aab076-a289-11e6-9e48-002590d590d0'),
    ('6', '47c8212e-46a3-11e7-ae80-002590d97638'),
    ('5', '4a1f2a8e-fb00-11e5-88df-002590d75952'),
    ('1', '4a6bf054-f242-11e7-9a27-002590d590d0'),
    ('1', '4b38bc74-a394-11e4-bdce-00e081bad46a'),
    ('1', '519c536a-364c-11e4-93d6-002590d97638'),
    ('1', '52914dc8-e99f-11e4-8e92-002590d97638'),
    ('2', '52e37d1e-0ecd-11e7-be0d-00e081bad46a'),
    ('8', '564a99c6-1973-11e4-ac41-002590d75952'),
    ('1', '5caada8e-3f9a-11e6-8c24-002590d97638'),
    ('25', '5d7d5fc0-8219-11e5-b149-002590d97638'),
    ('4', '60732158-5f72-11e4-ae81-002590d75952'),
    ('3209', '61b0139e-3141-11e6-a394-002590d97638'),
    ('1', '62fc3884-1464-11e7-9f47-002590d97638'),
    ('1', '6318576c-1ab4-11e6-b3da-002590d97638'),
    ('1', '646f7482-0742-11e5-a6e7-00e081bad46a'),
    ('1', '65b9df4c-bdf1-11e5-b33e-002590d8e030'),
    ('2', '665d1e00-8147-11e5-b149-002590d97638'),
    ('1', '67398d04-2029-11e7-809e-002590d8e030'),
    ('41', '686fe656-6d49-11e7-8a87-002590d97638'),
    ('1', '6b654696-a31e-11e4-85fb-00e081bad46a'),
    ('8', '6d72d2f4-16e3-11e4-b904-002590d75952'),
    ('1656', '6e583676-3141-11e6-a394-002590d97638'),
    ('391', '72a618a8-05b9-11e8-ae50-002590d97638'),
    ('1', '72dc7d10-780f-11e5-ab74-002590d75952'),
    ('1', '7327478c-ede3-11e6-9727-002590d97638'),
    ('9', '75e53622-5e6f-11e6-9838-00e081bad46a'),
    ('2', '769eeec4-f5e9-11e7-95eb-002590d590d0'),
    ('1', '7878292c-ed1b-11e6-bdec-002590d75952'),
    ('1', '79d48184-f9eb-11e7-b62e-002590d75952'),
    ('1', '7ab70902-4f62-11e7-ae80-002590d97638'),
    ('2', '7b1bc2b2-04a7-11e7-a14b-002590d8e030'),
    ('2', '7ba9dc1c-b67d-11e3-8d93-00e081bad46a'),
    ('1', '7cd51ae4-07fa-11e7-84b7-002590d590d0'),
    ('138', '806bd0bc-fa02-11e7-b62e-002590d75952'),
    ('6', '811f6c2a-46a3-11e7-a573-002590d97638'),
    ('8', '82d40d6c-5fe1-11e7-a3f7-002590d97638'),
    ('6', '8318a296-7f19-11e6-95b9-002590d97638'),
    ('26', '83e55b70-baea-11e7-8120-002590d97638'),
    ('5', '84be8ab2-0504-11e8-ae50-002590d97638'),
    ('26', '8531470a-cf0a-11e5-a26b-002590d97638'),
    ('1', '8605f05e-706c-11e7-8e5b-002590d97638'),
    ('36', '8685a114-ca0d-11e7-b0c8-002590d97638'),
    ('18', '8706f9a2-4a76-11e6-9829-002590d97638'),
    ('7518', '8996c160-4e29-11e5-9170-002590d8e030'),
    ('4', '8d9e77b4-d4b9-11e5-9548-00e081bad46a'),
    ('1', '8e55ca5e-bc93-11e2-ae76-00e081bad46b'),
    ('12', '8efb70b4-ee5c-11e5-8a0a-00e081bad46a'),
    ('2', '90789cb8-e721-11e7-a472-002590d8e030'),
    ('1', '907b302e-5db8-11e7-b59e-002590d75952'),
    ('1', '90a456ba-55b2-11e7-ae80-002590d97638'),
    ('2', '93a1c328-1375-11e6-8640-00e081bad46a'),
    ('2', '94232502-691b-11e6-84a7-002590d97638'),
    ('1', '9577453e-8816-11e3-bf81-00e081bad801'),
    ('120', '9582144e-cc13-11e5-a26b-002590d97638'),
    ('11', '9834b32c-7410-11e6-a339-002590d97638'),
    ('1', '9a8fc1f6-5db8-11e7-9736-002590d75952'),
    ('4945', '9a9900b8-05d3-11e8-ae50-002590d97638'),
    ('1', '9ac3be96-706b-11e7-a8c3-002590d97638'),
    ('1', '9ca5d2a8-014f-11e6-9b81-00e081bad46a'),
    ('1', '9d9b42fe-9498-11e3-ab4a-00e081bad46b'),
    ('1', '9fe908c2-e99f-11e4-93ff-002590d97638'),
    ('10', 'a0f18adc-d448-11e7-9d6c-002590d97638'),
    ('1', 'a15a8914-e779-11e5-a662-002590d8e030'),
    ('4', 'a37035ca-fd32-11e7-ae4e-002590d97638'),
    ('1', 'a42d652c-d662-11e4-a6db-002590d75952'),
    ('4', 'a5f7daa8-df81-11e5-982f-002590d97638'),
    ('3', 'a6ecbeb0-72a1-11e7-b498-002590d97638'),
    ('1747', 'a78ec398-1cc8-11e6-98fd-002590d97638'),
    ('3', 'a9f91b4c-6bc3-11e7-bf21-002590d97638'),
    ('2', 'acee1088-201e-11e6-a288-002590d97638'),
    ('28', 'b26aa22a-d84d-11e4-9ca4-002590d8e030'),
    ('3', 'b307f476-2bf7-11e7-aa77-002590d97638'),
    ('6', 'b319ca30-f0dd-11e5-85a2-002590d75952'),
    ('2', 'b546f8b6-c14f-11e7-9448-002590d590d0'),
    ('32', 'b5650f7e-baea-11e7-8120-002590d97638'),
    ('1', 'b78ff296-aa6e-11e7-a79f-002590d590d0'),
    ('31', 'b82b9206-895d-11e6-81d3-002590d97638'),
    ('1', 'b8f75572-413f-11e7-b3a2-002590d97638'),
    ('3', 'b986e4b6-0a95-11e7-9d96-002590d75952'),
    ('1', 'bc5b975a-b96c-11e7-819a-002590d97638'),
    ('43', 'bca58eb2-d84d-11e4-a4a7-002590d8e030'),
    ('6', 'c1969caa-08bf-11e7-b4d5-002590d75952'),
    ('9', 'c47dabce-7d3c-11e7-aab2-00e081bad46a'),
    ('115', 'c6c1eebc-0502-11e8-ae50-002590d97638'),
    ('13', 'c7f0a3c6-a995-11e7-a0ba-002590d97638'),
    ('6', 'c847f0b4-3c66-11e7-98b7-002590d97638'),
    ('1', 'c88eee5e-f15d-11e7-9394-002590d8e030'),
    ('2', 'caa4b288-02a5-11e8-ae50-002590d97638'),
    ('1', 'ccb2e37a-6aba-11e2-9ad6-00e081bad46b'),
    ('1', 'ced95ae2-a30e-11e4-bdce-00e081bad46a'),
    ('5', 'd17c5692-9c1c-11e6-80a0-002590d97638'),
    ('1', 'd186887c-f8ee-11e6-8f49-002590d97638'),
    ('1', 'd197d9a8-b61b-11e6-8747-002590d590d0'),
    ('2', 'd48e82bc-c506-11e5-8fb1-002590d590d0'),
    ('3', 'd4f7377e-c413-11e5-aee4-002590d97638'),
    ('1', 'd8c73044-c768-11e6-b8fc-002590d97638'),
    ('3', 'd90a5cd2-0035-11e8-ae4f-002590d97638'),
    ('2', 'da4c1494-b44e-11e5-9c45-00e081bad46a'),
    ('25', 'dad294d0-fcb3-11e5-9778-002590d75952'),
    ('5', 'dbdf4d38-cc1d-11e2-a8a4-00e081bad46b'),
    ('17', 'dda25cea-5b09-11e6-bd35-002590d97638'),
    ('2', 'de336ff6-6c0c-11e5-a2c0-002590d97638'),
    ('4', 'e042ef78-18e7-11e6-a455-00e081bad46a'),
    ('21', 'e10426d2-1642-11e5-ad65-002590d97638'),
    ('9', 'e2124f16-cc0a-11e6-8297-002590d97638'),
    ('3', 'e26fd642-9f81-11e5-9942-002590d75952'),
    ('4', 'e4245bd8-6274-11e5-887e-002590d97638'),
    ('3', 'e4fe9920-3f81-11e6-8c24-002590d97638'),
    ('377', 'e57c4556-91e3-11e5-9a47-002590d97638'),
    ('1', 'e6e89320-63d4-11e3-a772-00e081bad46b'),
    ('2', 'e8a263a8-476f-11e7-9e69-002590d97638'),
    ('7', 'e9c81014-dcd1-11e7-bc68-00e081bad46a'),
    ('56', 'ee6ef54c-1b98-11e7-8c29-002590d97638'),
    ('12', 'f0031ed0-8e71-11e4-b6e7-002590d97638'),
    ('1', 'f2fa8610-8f12-11e7-b157-002590d97638'),
    ('3', 'f300339a-28a6-11e6-9ac5-002590d97638'),
    ('2', 'f4a9815c-12d3-11e7-9f47-002590d97638'),
    ('1', 'f6318f78-7111-11e7-8855-002590d97638'),
    ('30', 'f793a158-7eff-11e6-95b9-002590d97638'),
    ('71', 'f92bbaf0-d84d-11e4-a4a7-002590d8e030')
]

for item in sorted(blocks, key=lambda x: int(x[0]), reverse=True):
    bl = inf.get(item[1])
    impressions_block = int(stats[item[1]])
    broc_imp = int(item[0])
    if bl is not None:
        if impressions_block <= 0:
            impressions_block = 1
        print '%.3f\t%s\t%s\t%s\t%s\t%s' % (broc_imp / (impressions_block/100.0), impressions_block, broc_imp, bl['guid'], bl['domain'], bl['user'])